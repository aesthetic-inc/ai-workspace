---
description: Security best practices and guidelines
globs: ["**/*.ts", "**/*.tsx", "**/*.py", "**/*.js"]
---

# Security Rules

## Secrets Management

### Never Hardcode Secrets
```typescript
// ❌ Critical - Never do this
const API_KEY = 'sk-1234567890abcdef';
const DATABASE_URL = 'postgres://user:password@localhost/db';

// ✅ Good - Use environment variables
const API_KEY = process.env.API_KEY;
const DATABASE_URL = process.env.DATABASE_URL;

// ✅ Good - Validate env vars at startup
function getRequiredEnv(key: string): string {
  const value = process.env[key];
  if (!value) {
    throw new Error(`Missing required environment variable: ${key}`);
  }
  return value;
}
```

### Environment Files
```bash
# .env files must be in .gitignore
.env
.env.local
.env.*.local
*.pem
*.key
```

### Secrets in Git
- Never commit secrets, even in "test" files
- Use git-secrets or similar pre-commit hooks
- Rotate any accidentally committed secrets immediately

## Input Validation

### Validate All User Input
```typescript
import { z } from 'zod';

// Define schemas
const UserInputSchema = z.object({
  email: z.string().email(),
  name: z.string().min(1).max(100),
  age: z.number().int().positive().max(150),
});

// Validate input
function createUser(input: unknown): User {
  const validated = UserInputSchema.parse(input);
  return saveUser(validated);
}
```

### Sanitize HTML Content
```typescript
// ❌ Dangerous - XSS vulnerability
element.innerHTML = userInput;

// ✅ Safe - Use textContent for plain text
element.textContent = userInput;

// ✅ Safe - Use sanitization library for HTML
import DOMPurify from 'dompurify';
element.innerHTML = DOMPurify.sanitize(userInput);
```

### React XSS Prevention
```tsx
// ❌ Dangerous - dangerouslySetInnerHTML
<div dangerouslySetInnerHTML={{ __html: userContent }} />

// ✅ Safe - Normal rendering (auto-escaped)
<div>{userContent}</div>

// ✅ Safe - If HTML needed, sanitize first
<div dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(userContent) }} />
```

## API Security

### SQL Injection Prevention
```typescript
// ❌ Dangerous - String interpolation
const query = `SELECT * FROM users WHERE id = ${userId}`;

// ✅ Safe - Parameterized queries
const query = 'SELECT * FROM users WHERE id = $1';
const result = await db.query(query, [userId]);

// ✅ Safe - ORM with proper escaping
const user = await prisma.user.findUnique({ where: { id: userId } });
```

### Authentication
```typescript
// Always hash passwords
import bcrypt from 'bcrypt';

const SALT_ROUNDS = 12;

async function hashPassword(password: string): Promise<string> {
  return bcrypt.hash(password, SALT_ROUNDS);
}

async function verifyPassword(password: string, hash: string): Promise<boolean> {
  return bcrypt.compare(password, hash);
}
```

### Authorization
```typescript
// Check permissions on every request
async function updatePost(postId: string, userId: string, data: PostData): Promise<Post> {
  const post = await getPost(postId);

  // Always verify ownership/permissions
  if (post.authorId !== userId && !await isAdmin(userId)) {
    throw new ForbiddenError('Not authorized to update this post');
  }

  return savePost(postId, data);
}
```

### Rate Limiting
```typescript
import rateLimit from 'express-rate-limit';

const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // Limit each IP to 100 requests per window
  message: 'Too many requests, please try again later',
});

app.use('/api/', apiLimiter);
```

### CORS Configuration
```typescript
import cors from 'cors';

// ❌ Dangerous - Allow all origins
app.use(cors());

// ✅ Safe - Explicit origins
app.use(cors({
  origin: ['https://example.com', 'https://app.example.com'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
}));
```

## Security Headers
```typescript
import helmet from 'helmet';

app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", 'data:', 'https:'],
    },
  },
  hsts: { maxAge: 31536000, includeSubDomains: true },
}));
```

## Dependency Security

- Run `npm audit` / `pip-audit` regularly
- Keep dependencies updated
- Review new dependencies before adding
- Use lockfiles (package-lock.json, poetry.lock)
